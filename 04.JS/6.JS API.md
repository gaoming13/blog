### Atomics
```js
const workerScriptBlobUrl = URL.createObjectURL(new Blob([`
  self.onmessage = ({data}) => {
    const view = new Uint32Array(data);
    for (let i = 1; i <= 1000; i++) {
      // view[0] += 1;
      // åŸå­æ“ä½œ
      Atomics.add(view, 0, 1);
    }
  };
`]));
const buffer = new SharedArrayBuffer(4);
const view = new Uint32Array(buffer); view[0] = 0;
for (let i = 1; i <= 10; i++) {
  const woker = new Worker(workerScriptBlobUrl);
  woker.postMessage(buffer);
}
setTimeout(() => console.log(view[0]), 1000);
```
- å¤šä¸ªä¸Šä¸‹æ–‡è®¿é—® SharedArrayBuffer æ—¶,åŒæ—¶å¯¹ç¼“å†²åŒºæ‰§è¡Œæ“ä½œ,å¯èƒ½å‡ºç°èµ„æºäº‰ç”¨é—®é¢˜
- Atomicsé€šè¿‡å¼ºåˆ¶åŒä¸€æ—¶åˆ»åªèƒ½å¯¹ç¼“å†²åŒºæ‰§è¡Œä¸€ä¸ªæ“ä½œ

### è·¨ä¸Šä¸‹æ–‡æ¶ˆæ¯
```js
const iframeWin = document.querySelector('iframe').contentWindow;
iframeWin.postMessage({a: 123, b: 456}, '*');
```
- ç®€ç§° XDM(cross-document messaging),ä¸€ç§åœ¨ä¸åŒæ‰§è¡Œä¸Šä¸‹æ–‡(ä¸åŒå·¥ä½œçº¿ç¨‹/ä¸åŒæºçš„é¡µé¢)é—´ä¼ é€’ä¿¡æ¯çš„èƒ½åŠ›
- postMessage(æ¶ˆæ¯, ç›®æ ‡æ¥æ”¶æºçš„å­—ç¬¦ä¸²);

### Encoding API
- ç”¨äºå­—ç¬¦ä¸²ä¸å®šå‹æ•°ç»„ä¹‹é—´çš„è½¬æ¢
- æ–‡æœ¬ç¼–ç 
  - æ‰¹é‡ç¼–ç 
    - TextEncoder.prototype.encode(å­—ç¬¦ä¸²)
      ```js
      const textEncoder = new TextEncoder();
      textEncoder.encode('ğŸ˜„fä¸­');
      // Uint8Array(8)Â [240, 159, 152, 132, 102, 228, 184, 173]
      encodeURIComponent('ğŸ˜„fä¸­');
      // %F0%9F%98%84 f %E4%B8%AD
      // parseInt('F0', 16) = 240 = 11110000
      // parseInt('9F', 16) = 159 = 10011111
      // parseInt('98', 16) = 152 = 10011000
      // parseInt('84', 16) = 132 = 10000100
      // 'f'.codePointAt()  = 102 = 01100110
      // parseInt('E4', 16) = 228 = 11100100
      // parseInt('B8', 16) = 184 = 10111000
      // parseInt('AD', 16) = 173 = 10101101
      ```
    - TextEncoder.prototype.encodeInto(å­—ç¬¦ä¸², ç›®æ ‡Unit8Array)
      ```js
      const textEncoder = new TextEncoder();
      const arr = new Uint8Array(3);
      const res = textEncoder.encodeInto('fä¸­', arr);
      // res: {read: 1, written: 1}
      // arr: Uint8Array(3)Â [102, 0, 0]
      ```
  - æµç¼–ç 
    - TextEncoderStream å°†è§£ç åçš„æ–‡æœ¬æµé€šè¿‡ç®¡é“è¾“å…¥æµç¼–ç å™¨å¾—åˆ°ç¼–ç åæ–‡æœ¬å—çš„æµ
    ```js
    async function * chars() {
      const decodedText = 'foo';
      for (let char of decodedText) {
        yield await new Promise((resolve) => {
          setTimeout(resolve, 1000, char);
        });
      }
    }
    // æ–‡æœ¬æµ
    const textStream = new ReadableStream({
      async start(constroller) {
        for await (const v of chars()) {
          constroller.enqueue(v);
        }
        constroller.close();
      }
    });
    // ç¼–ç åæ–‡æœ¬å—çš„æµ
    const encodeTextStream = textStream.pipeThrough(new TextEncoderStream());
    // è¯»å–æ–‡æœ¬å—æµ
    const reader = encodeTextStream.getReader();
    (async () => {
      while(true) {
        const res = await reader.read();
        if (res.done) break;
        console.log(res);
      }
    })();
    ```
- æ–‡æœ¬è§£ç 
  - ä¸ç¼–ç å™¨ç±»ä¸åŒï¼Œåœ¨å°†å®šå‹æ•°ç»„è½¬æ¢ä¸ºå­—ç¬¦ä¸²æ—¶ï¼Œè§£ç å™¨æ”¯æŒéå¸¸å¤šçš„å­—ç¬¦ä¸²ç¼–ç (é»˜è®¤UTF-8)
  - æ‰¹é‡è§£ç 
    ```js
    const textDecoder = new TextDecoder('utf-8');
    textDecoder.decode(Uint8Array.of(102, 111, 111)); // foo
    ```
  - æµè§£ç 
    - å°†ç¼–ç åçš„æ–‡æœ¬æµé€šè¿‡ç®¡é“ è¾“å…¥æµè§£ç å™¨ä¼šå¾—åˆ°è§£ç åæ–‡æœ¬å—çš„æµ
    - è§£ç å™¨æµä¼šä¿æŒå—ç‰‡æ®µæŒ‡å¯¼å–åˆ°å®Œæ•´çš„å­—ç¬¦
    ```js
    async function* chars() {
      for (const u8 of [240, 159, 152, 132, 102, 228, 184, 173]) {
        yield await new Promise((resolve) => setTimeout(resolve, 100, Uint8Array.of(u8)));
      }
    }
    // æ–‡æœ¬æµ
    const textStream = new ReadableStream({
      async start(constroller) {
        for await (const u8 of chars()) {
          constroller.enqueue(u8);
        }
        constroller.close();
      }
    });
    // æµè¿‡ç®¡é“è§£ç 
    const decodeTextStream = textStream.pipeThrough(new TextDecoderStream());
    // è¯»å–
    const reader = decodeTextStream.getReader();
    (async () => {
      while(true) {
        const res = await reader.read();
        if (res.done) break;
        console.log(res);
      }
    })();
    ```

### File API ä¸ Blob API
- File ç±»å‹
  - æ–‡ä»¶è¾“å…¥å…ƒç´ æ‹¥æœ‰fileså±æ€§
  - e.target.files[0].name æœ¬åœ°ç³»ç»Ÿæ–‡ä»¶å
  - e.target.files[0].size æ–‡ä»¶å­—èŠ‚å¤§å°
  - e.target.files[0].type æ–‡ä»¶MIMEç±»å‹
  - åŸå‹é“¾ï¼šfile > File > Blob > Object
  ```js
  // <input id="file1" type="file" name="file1">
  const domFile1 = document.querySelector('#file1');
  domFile1.addEventListener('change', function(e) {
    console.log(e.target.files);
  });
  ```
- FileReader ç±»å‹
  - è¡¨ç¤ºä¸€ç§å¼‚æ­¥æ–‡ä»¶è¯»å–æœºåˆ¶ï¼Œç±»ä¼¼äº XMLHttpRequest
  - progress äº‹ä»¶æ¯50æ¯«ç§’å°±ä¼šè§¦å‘ä¸€æ¬¡ï¼Œä¸ XHR çš„ progress äº‹ä»¶å…·æœ‰ç›¸åŒçš„ä¿¡æ¯
  ```js
  const file = e.target.files[0];
  // è¯»å–æ–‡ä»¶
  const reader = new FileReader();
  // reader.readAsText(file); // çº¯æ–‡æœ¬å†…å®¹
  // reader.readAsDataURL(file); // å†…å®¹æ•°æ®çš„URI
  // reader.readAsBinaryString(file); // æ¯ä¸ªå­—ç¬¦çš„äºŒè¿›åˆ¶æ•°æ®
  reader.readAsArrayBuffer(file); // ä»¥ ArrayBuffer å½¢å¼çš„æ•°æ®
  reader.onload = () => console.log(reader.result);
  reader.onprogress = (e) => console.log(e.loaded + '/' + e.total);
  reader.onerror = (e) => console.log(reader.error);
  ```
- FileReaderSync ç±»å‹
  - æ˜¯ FileReader çš„åŒæ­¥ç‰ˆæœ¬,åªæ˜¯æ•´ä¸ªæ–‡ä»¶éƒ½åŠ è½½åˆ°å†…å­˜åæ‰ç»§ç»­æ‰§è¡Œ
  - åªåœ¨å·¥ä½œçº¿ç¨‹ä¸­å¯ç”¨
- Blob ä¸éƒ¨åˆ†è¯»å–
  - Blobæ˜¯Fileçš„çˆ¶ç±»ï¼Œblobè¡¨ç¤º äºŒè¿›åˆ¶å¤§å¯¹è±¡(binary large object)
  - æ˜¯å¯¹ä¸å¯ä¿®æ”¹äºŒè¿›åˆ¶æ•°æ®çš„å°è£…ç±»å‹
  - blob.size
  - blob.type
  - blob.slice() åˆ‡åˆ†æ•°æ®
  ```js
  const blob1 = new Blob(['foo']);
  const blob2 = new Blob(['{"a":123}'], { type: 'application/json' });
  const blob3 = new Blob(['<div>åˆ—1</div><span>è¡Œ1</span>'], { type: 'text/html' });
  const reader = new FileReader();
  reader.readAsText(blob3.slice(0, 10));
  reader.onload = () => console.log(reader.result);
  ```
- å¯¹è±¡ URL ä¸ Blob
  - å¯¹è±¡URLä¹Ÿç§°åš Blob URL, æ˜¯æŒ‡å¼•ç”¨å­˜å‚¨åœ¨ File æˆ– Blob ä¸­æ•°æ®çš„URL
  - ä¼˜ç‚¹æ˜¯ä¸ç”¨æŠŠæ–‡ä»¶è¯»å–åˆ° JS ä¹Ÿå¯ä»¥ä½¿ç”¨æ–‡ä»¶
  - åˆ›å»ºå¯¹è±¡URL: window.URL.createObjectURL(Fileæˆ–Blobå¯¹è±¡)
  - ä½¿ç”¨å®Œå¯¹è±¡URL,æœ€å¥½èƒ½é‡Šæ”¾ä¸ä¹‹å…³è”çš„å†…å­˜: window.URL.revokeObjectURL()
- è¯»å–æ‹–æ”¾æ–‡ä»¶
  ```js
  const dragDom = document.querySelector('#drag1');
  function hander(e) {
    e.preventDefault();
    if (e.type == 'drop') {
      dragDom.innerHTML = '<img src="' + window.URL.createObjectURL(e.dataTransfer.files[0]) + '">';
    }
  }
  dragDom.addEventListener('dragenter', hander);
  dragDom.addEventListener('dragover', hander);
  dragDom.addEventListener('drop', hander);
  ```

### åª’ä½“å…ƒç´ 
- audio / video çš„API

### åŸç”Ÿæ‹–æ”¾
- åŸä½ç½®
  - dragstart æ‹–åŠ¨å¼€å§‹,æŒ‰ä½é¼ æ ‡é”®ä¸æ”¾å¹¶å¼€å§‹ç§»åŠ¨é¼ æ ‡çš„é‚£ä¸€åˆ»,ç±»ä¼¼äºmousemove
  - drag ç›®æ ‡è¿˜è¢«æ‹–åŠ¨,æŒç»­è§¦å‘dragäº‹ä»¶
  - dragend æ‹–åŠ¨åœæ­¢
- ç›®æ ‡ä½ç½®
  - dragenter æ‹–åŠ¨åˆ°ç›®æ ‡ä¸Š,ç±»ä¼¼äºmouseover
  - dragover æ‹–åŠ¨åœ¨ç›®æ ‡èŒƒå›´å†…,æŒç»­è§¦å‘
  - drop/dragleave drop æ”¾åˆ°ç›®æ ‡ä¸Š/ç¦»å¼€ç›®æ ‡
- dateTransferå¯¹è±¡
  - e.dataTransfer.setData('a', 1)
  - e.dataTransfer.getData('a')
  - e.dataTransfer.dropEffect å…è®¸å“ªç§æ”¾ç½®è¡Œä¸º,æ˜¾ç¤ºä¸åŒçš„å…‰æ ‡
    - none è¢«æ‹–åŠ¨å…ƒç´ ä¸èƒ½æ”¾åˆ°è¿™é‡Œ,è¿™æ˜¯é™¤æ–‡æœ¬æ¡†ä¹‹å¤–æ‰€æœ‰å…ƒç´ çš„é»˜è®¤å€¼
    - move è¢«æ‹–åŠ¨å…ƒç´ åº”è¯¥ç§»åŠ¨åˆ°æ”¾ç½®ç›®æ ‡
    - copy è¢«æ‹–åŠ¨å…ƒç´ åº”è¯¥å¤åˆ¶åˆ°æ”¾ç½®ç›®æ ‡
    - link æ”¾ç½®ç›®æ ‡ä¼šå¯¼èˆªåˆ°è¢«æ‹–åŠ¨å…ƒç´ ,ä»…é™URL
  - e.dataTransfer.effectAllowed è¡¨ç¤ºè¢«æ‹–åŠ¨çš„å…ƒç´ æ˜¯å¦å…è®¸ dropEffect
    - å¿…é¡»åœ¨ ondragstart äº‹ä»¶å¤„ç†ç¨‹åºä¸­è®¾ç½®è¿™ä¸ªå±æ€§
    - uninitialized æ²¡æœ‰ç»™è¢«æ‹–åŠ¨å…ƒç´ è®¾ç½®åŠ¨ä½œ
    - none è¢«æ‹–åŠ¨å…ƒç´ ä¸Šæ²¡æœ‰å…è®¸çš„æ“ä½œ
    - copy åªå…è®¸ copy è¿™ç§ dropEffect
    - link åªå…è®¸ link è¿™ç§ dropEffect
    - move åªå…è®¸ move è¿™ç§ dropEffect
    - copyLink åªå…è®¸ copy+link è¿™2ç§ dropEffect
    - copyMove åªå…è®¸ copy+love è¿™2ç§ dropEffect
    - linkMove åªå…è®¸ link+move è¿™2ç§ dropEffect
    - all å…è®¸æ‰€æœ‰ dropEffect
- å¯æ‹–åŠ¨èƒ½åŠ›
  - é»˜è®¤æ–‡æœ¬é€‰ä¸­åå¯æ‹–åŠ¨,å›¾ç‰‡å’Œé“¾æ¥å¯æ‹–åŠ¨
  - è®¾ç½®å…ƒç´ æ˜¯å¦å¯æ‹–åŠ¨,åœ¨HTMLå…ƒç´ ä¸Šæ·»åŠ  draggable=true/false
```js
let fromLi;
const domLiArr = document.querySelectorAll('li');
for (const domLi of domLiArr) {
  domLi.addEventListener('dragstart', function(e) {
    e.dataTransfer.setData('a', 123);
    e.dataTransfer.dropEffect = 'move';
    e.dataTransfer.effectAllowed = 'move';
    fromLi = e.target;
    console.log('å¼€å§‹æ‹–åŠ¨');
  });
  // domLi.addEventListener('drag', (e) => console.log('æ‹–åŠ¨ä¸­'));
  domLi.addEventListener('dragend', (e) => console.log('æ‹–åŠ¨åœæ­¢'));
}
const domUlArr = document.querySelectorAll('ul');
for (domUl of domUlArr) {
  domUl.addEventListener('dragenter', (e) => console.log('æ‹–åŠ¨è¿›å…¥'));
  domUl.addEventListener('dragover', (e) => {
    e.preventDefault();
    // console.log('ç›®æ ‡å†…æ™ƒåŠ¨');
  });
  domUl.addEventListener('drop', (e) => {
    e.preventDefault();
    e.target.append(fromLi);
    console.log(e);
    console.log('æ”¾ä¸‹äº†');
  });
  domUl.addEventListener('dragleave', (e) => console.log('ç¦»å¼€äº†'));
}
```

### Notifications API
```js
const btn = document.querySelector('button');
$0.addEventListener('click', function() {
  // è·å–é€šçŸ¥æƒé™
  Notification.requestPermission().then((permission) => {
    console.log(permission); // grantedæˆ–denied
  });
});
// å‘é€é€šçŸ¥
const n1 = new Notification('è¿™æ˜¯æ ‡é¢˜', {
  body: 'è¿™æ˜¯å†…å®¹',
  image: '1.jpg',
  vibrate: true
});
// éšè—é€šçŸ¥
setTimeout(() => n1.close(), 1000);
```

### Page Visibility API
- document.visibilityState hiddené¡µé¢è¢«éšè—/visibleé¡µé¢å¯è§/prerenderé¡µé¢åœ¨å±å¤–é¢„æ¸²æŸ“
- visibilitychange äº‹ä»¶
- document.hidden å¸ƒå°”å€¼,é¡µé¢æ˜¯å¦éšè—,é¡µé¢åœ¨åå°æ ‡ç­¾é¡µæˆ–æœ€å°åŒ–

### Streams API
- Stream API ç›´æ¥è§£å†³çš„é—®é¢˜æ˜¯ å¤„ç†ç½‘ç»œè¯·æ±‚å’Œè¯»å†™ç£ç›˜
- å¯è¯»æµï¼šæ•°æ®åœ¨å†…éƒ¨ä»åº•å±‚æºè¿›å…¥æµ, ç„¶åç”±æ¶ˆè´¹è€…(consumer)è¿›è¡Œå¤„ç†
- å¯å†™æµï¼šç”Ÿäº§è€…(producer)å°†æ•°æ®å†™å…¥æµ, æ•°æ®åœ¨å†…éƒ¨ä¼ å…¥åº•å±‚æ•°æ®æ§½(sink)
- è½¬æ¢æµï¼šç”±2ç§æµç»„æˆ,å¯è¯»æµç”¨äºè¾“å‡ºæ•°æ®(å¯è¯»ç«¯),å¯å†™æµç”¨äºæ¥æ”¶æ•°æ®(å¯å†™ç«¯)
  - 2ä¸ªæµä¹‹é—´æ˜¯è½¬æ¢ç¨‹åº(transfromer),å¯ä»¥æ ¹æ®éœ€è¦æ£€æŸ¥å’Œä¿®æ”¹æµå†…å®¹
- æµçš„åŸºæœ¬å•ä½æ˜¯å—(chunk),å¯ä»¥æ˜¯ä»»æ„æ•°æ®ç±»å‹,ä½†é€šå¸¸æ˜¯å®šå‹æ•°ç»„
```js
/*** å¯è¯»æµ ***/
// ç”Ÿæˆå™¨
async function* gen1() {
  for (let i = 0; i < 5; i++) {
    yield await new Promise((resolve) => setTimeout(resolve, 1000, i));
  }
}
// å¯è¯»æµ
const readStream = new ReadableStream({
  async start (constroller) {
    for await (const chunk of gen1()) {
      constroller.enqueue(chunk);
    }
    constroller.close();
  }
});
(async () => {
  // è¯»å–å¯è¯»æµ
  const reader = readStream.getReader();
  while (true) {
    const res = await reader.read();
    if (res.done) break;
    console.log(res);
  }
})();

/*** å¯å†™æµ ***/
// ç”Ÿæˆå™¨
async function* gen1() {
  for (let i = 0; i < 5; i++) {
    yield await new Promise((resolve) => setTimeout(resolve, 1000, i));
  }
}
// å¯å†™æµ
const writeStream = new WritableStream({
  write (chunk) {
    console.log(chunk);
  }
});
// å†™å…¥å¯å†™æµ
(async () => {
  const writer = writeStream.getWriter();
  for await (let chunk of gen1()) {
    writer.write(chunk);
  }
  writer.close();
})();

/*** è½¬æ¢æµ ***/
// ç”Ÿæˆå™¨
async function* gen1() {
  for (let i = 0; i < 5; i++) {
    yield await new Promise((resolve) => setTimeout(resolve, 1000, i));
  }
}
// è½¬æ¢æµ
const { writable, readable } = new TransformStream({
  transform(chunk, constroller) {
    constroller.enqueue(chunk * 2);
  }
});
// å†™å…¥æµ
const writer = writable.getWriter();
(async () => {
  for await (let chunk of gen1()) {
    await writer.ready;
    writer.write(chunk);
  }
})();
// å¯è¯»æµ
const reader = readable.getReader();
(async () => {
  while (true) {
    const res = await reader.read();
    if (res.done) break;
    console.log(res);
  }
})();


/*** è½¬æ¢æµ ***/
// ç”Ÿæˆå™¨
async function* gen1() {
  for (let i = 0; i < 5; i++) {
    yield await new Promise((resolve) => setTimeout(resolve, 1000, i));
  }
}
// å¯è¯»æµ
const readStream = new ReadableStream({
  async start (constroller) {
    for await (const chunk of gen1()) {
      constroller.enqueue(chunk);
    }
    constroller.close();
  }
});
// ç®¡é“æµ
const readStream1 = readStream.pipeThrough(new TransformStream({
  transform(chunk, constroller) {
    constroller.enqueue(chunk * 2);
  }
}));
// å¯è¯»æµ
const reader = readStream1.getReader();
(async () => {
  while (true) {
    const res = await reader.read();
    if (res.done) break;
    console.log(res);
  }
})();
```

### è®°æ—¶API


> https://developer.mozilla.org/zh-CN/docs/Web/API/Performance_API
### Performance API é«˜é‡‡æ ·ç‡
- å…¨å±€å˜é‡ performance æ˜¯ Performance çš„å®ä¾‹å¯¹è±¡
- åŸå‹å±æ€§(Performance.prototype)
  - performance.timing è¿”å›ä¸€ä¸ª PerformanceTiming å¯¹è±¡, ä¸å»¶æ—¶ç›¸å…³çš„æ€§èƒ½ä¿¡æ¯
  - performance.navigation
- åŸå‹æ–¹æ³•(Performance.prototype) è¿”å›ä¸€ä¸ª PerformanceNavigation å¯¹è±¡, åœ¨ç»™å®šæµè§ˆä¸Šä¸‹æ–‡ä¸­å‘ç”Ÿçš„å¯¼èˆªç±»å‹
  - performance.now() è¿”å›åˆ›å»ºæµè§ˆå™¨ä¸Šä¸‹æ–‡çš„æ—¶é—´(å•ä½ms,ç²¾ç¡®åˆ°5uså¾®ç§’)
  - performance.getEntries({name: "entry_name", entryType: "mark"}) ç­›é€‰è·å– PerformanceEntry æ•°ç»„
  - performance.mark('æ ‡è®°1') åˆ›å»ºæ ‡è®°
  - performance.mark('æ ‡è®°2') åˆ›å»ºæ ‡è®°
  - performance.measure('é—´è·1', 'æ ‡è®°1', 'æ ‡è®°2');
  - performance.getEntriesByName('é—´è·1')[0].duration;
  - performance.clearMarks() åˆ é™¤æ‰€æœ‰æ ‡è®°
  - performance.clearMeasures() åˆ é™¤æ‰€æœ‰æµ‹é‡

### PerformanceEntry
- ä»£è¡¨äº† performance æ—¶é—´åˆ—è¡¨ä¸­æ¯ä¸ª metric æ•°æ®
- å¯æ‰‹åŠ¨æ„å»º mark æˆ– measure ä¸»åŠ¨ç”Ÿæˆ
- åœ¨èµ„æºåŠ è½½çš„æ—¶å€™, ä¹Ÿä¼šè¢«åŠ¨ç”Ÿæˆ(å¦‚å›¾ç‰‡ã€jsã€cssç­‰èµ„æºåŠ è½½)
- åŸå‹å±æ€§
  - name åå­—
  - entryType ä¸ŠæŠ¥ç±»å‹(frameã€navigationã€resourceã€markã€measureã€paint)
  - startTime ä¸ŠæŠ¥å¼€å§‹çš„æ—¶é—´(ms)
  - duration è€—æ—¶(ms)